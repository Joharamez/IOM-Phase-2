package src;

import java.io.File;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Date;
import java.util.Scanner;
public class TestIOM {
    
    public static Scanner input = new Scanner (System.in);
    
    public static ProductDatabase productData = new ProductDatabase("products.csv");
    public static AVLTree<Integer, Product>  products = productData.getproductsIDs();
    
    public static CustomerDatabase customerData = new CustomerDatabase("customers.csv");
    public  static AVLTree<Integer, Customer> customers = customerData.getCustomerIDs();
    
    public static OrderDatabase orderData = new OrderDatabase("orders.csv" , customerData.getCustomerIDs());
    public static AVLTree<Integer, Order>  orders = orderData.getOrderDatabase();
    
    public static ReviewDatabase reviewData= new ReviewDatabase("reviews.csv", productData.getproductsIDs());
    public static LinkedList<Review> reviews = reviewData.getReviewDatabase();


public static void main(String[]args) {
		
	int managerChoice;
	int productChoice;
	int customerChoice;
	int orderChoice;
	int reviewChoice;
	do {// manager menu
		System.out.println("*Inventory Management System*");
		System.out.println("Please enter your choice");
		System.out.println("1.Products");
		System.out.println("2.Customers");
		System.out.println("3.Orders");
		System.out.println("4.Reviews");
		System.out.println("5.Exit with saving.");
		System.out.println("6.Exit without saving.");
		managerChoice=input.nextInt();
		
		switch(managerChoice) { 
		
		case 1:// products menu
			do {
				System.out.println("Enter your choice:");
		        System.out.println("1.Add new product");
		        System.out.println("2.Remove a product");
		        System.out.println("3.Update a product");
		        System.out.println("4.Search for a product"); // id or name
		        System.out.println("5.Track out-of-stock products");
		        System.out.println("6.List all products within a price range");
		        System.out.println("7.Display all customers who reviewed a specific product sorted by rating");
		        System.out.println("8.Display all customers who reviewed a specific product sorted by customer ID");
		        System.out.println("9.Display all products");
		        System.out.println("10.Return to the main menu");
		        productChoice = input.nextInt();
		        
		        switch(productChoice) {
		        case 1: //Add new product
		        	productData.addProduct();
		        	break;
		        case 2: //Remove a product
		        	productData.removeProduct();
		        	break;
		        case 3://Update a product
		        	productData.updateProduct();
		        	break;
		        case 4: //Search for a product
					System.out.println("Enter your choice:");
		        	System.out.println("1. Search by ID");
		        	System.out.println("2. Search by name");
		        	int searchChoice=input.nextInt();

		        	switch(searchChoice) {
		        	case 1:// Search by ID
		                Product productID = productData.searchProductID();
		        	break;
		        	case 2:// Search by name
		                Product prouctName = productData.searchProductName();
		        		break;
		        	}
		        	
		        	break;
		        	
		        case 5: //Track out-of-stock products
		        	productData.outOfStock();
		        	break;
		        	
		        case 6://List all products within a price range
		        	System.out.println("Enter the following:");
	                System.out.println("Minimum Price:");
	                double minPrice = input.nextDouble();
	                System.out.println("Maximum Price:");
	                double maxPrice = input.nextDouble();
	                
	                while (minPrice >= maxPrice)
	                {
	                    System.out.println("Please re-enter the range:");
		                System.out.println("Minimum Price:");
		                minPrice = input.nextDouble();
		                System.out.println("Maximum Price:");
		                maxPrice = input.nextDouble();
	                }
	                LinkedList<Product> data = productData.getPriceRange(minPrice, maxPrice);
	                if (data.empty())
	                     System.out.println("No products within this range");
	                else
	                    data.print();
		        
		        	break;
		        	
		        case 7://Display all customers who reviewed a specific product sorted by rating
		        	customersBasedOnRating();
		        	break;
		        	
		        case 8://Display all customers who reviewed a specific product sorted by cutomer ID
		        	customersBasedOnID();
		        	break;
		        	
		        case 9://Display all products
	                productData.getproductsIDs().printKeys_Data();
		        	break;
		        	
		        case 10://exit
		        	break;
		        }
				
			}while (productChoice!=10);
			break;
			
		case 2:// Customer Menu
			do {
				System.out.println("Enter your choice");
		        System.out.println("1.Register new customer");
		        System.out.println("2.Place an order for a specific customer");
		        System.out.println("3.View order history");
		        System.out.println("4.Reviews for a specific customer");
		        System.out.println("5.Search for a customer by ID");
		        System.out.println("6.Display all customers");
		        System.out.println("7.Display all customers in alphabetic order");
		        System.out.println("8.Return to the main menu");
		        customerChoice = input.nextInt();;
		        switch (customerChoice) {
		        case 1: //Register new customer"
		        	customerData.registerCustomer();
		        	break;
		        case 2: //Place an order
		        	placeOrder();
		        	break;
		        case 3: //View order history"
		        	customerData.orderHistory();
		        	break;
		        	
		        case 4: //Reviews for a specific customer
		        	reviewsForaCustomer();
		        	break;
		        	
		        case 5: //Search for a customer by ID
		        	customerData.getCustomerID();
		        	break;
		        	
		        case 6: //Display all customers
	                customers.printKeys_Data();
		        	break;
		        	
		        case 7: //Display all customers in alphabetic order
	                customerData.printNamesAlphabetically();
		        	break;
		        	
		        case 8: //Exit
		        	break;
		        }
			}while(customerChoice!=8);
			break;

		case 3:// Order Menu
			System.out.println("Enter your choice");
			System.out.println("1.Create an order");
	        System.out.println("2.Cancel order");
	        System.out.println("3.Update order status");
	        System.out.println("4.Search for an order");
	        System.out.println("5.Display orders between dates");
	        System.out.println("6.Return to the main menu");
	        orderChoice = input.nextInt();
	        
	        switch (orderChoice) {
	        case 1: //Create an order
	        	placeOrder();
	        	break;
	        	
	        case 2: //Cancel order
                System.out.println("Enter order ID:");
                int orderID = input.nextInt();
                orderData.cancelOrder(orderID);	        	
                break;
	        	
	        case 3://Update order status
                if (orders.empty())
                    System.out.println("There is no order history");
                else
                {
                    System.out.println("Enter order ID:");
                    int orderID2 = input.nextInt();
                    orderData.updateOrder(orderID2);
                }
	        	break;
	        	
	        case 4: //Search for an order
                if (orders.empty())
                    System.out.println("There is no order history");
                else
                {
                    System.out.println("Enter order ID:");
                    int orderID3 = input.nextInt();
                    System.out.println(orderData.searchOrderID(orderID3));
                }
	        	break;
	        	
	        case 5://Display orders between dates
	        	System.out.println("Enter first date (dd/MM/yyyy)");
                String date1 = input.next();
                
                System.out.println("Enter second date (dd/MM/yyyy)");
                String date2 = input.next();
                
                AVLTree<Date, Order> o = orderData.ordersBetweenDates(date1, date2);
                o.printData();	            
                break;
	        	
	        case 6://exit
	        	break;
	        }
			break;
			
		case 4: //Review Menu
			System.out.println("Enter your choice");
	        System.out.println("1.Add review");
	        System.out.println("2.Edit review");
	        System.out.println("3.Get an average rating for product");
	        System.out.println("4.Top 3 highest rated products");
	        System.out.println("5.Top 3 most reviewed products");
	        System.out.println("6.Common products between 2 customers with an average rating 4+");
	        System.out.println("7.Return Main menu");
	        reviewChoice = input.nextInt();
	        
	       	        switch(reviewChoice) {
	        case 1://Add review
	        	createReview();
	        	break;
	        	
	        case 2: //Edit review
	        	  reviewData.updateReview();
	        	break;
	        	
	        case 3: //Get an average rating for product
	        {
                System.out.println("Enter product ID:");
                int productID = input.nextInt();

                while (!products.find(productID))//Product ID doesn't exist.
                {
                    System.out.println("Entered product ID doesn't exist. Kindly re-enter the product ID.");
                    productID = input.nextInt();
                }
                double AVG = averageRating(productID);
                System.out.println("The average rating is " + AVG);
            }
	        	break;
	        	
	        case 4: //Top 3 highest rated products
	        	top3ProductsRating(); //CHANNGE NAME
	        	break;
	        	
	        case 5: //Top 3 most reviewed products
	        	top3ProductsReviewd(); //CHANNGE NAME
	        	break;
	        	
	        case 6://Common products with an average rating 4+
	        
                System.out.println("First Customer");
                Customer c1 =customerData.getCustomerID(); 
                while(c1==null) {
                	  c1 =customerData.getCustomerID(); 
                }
                
                System.out.println("Second Customer");
                Customer c2 =customerData.getCustomerID();
                
                while(c2==null) {
                	  c2 =customerData.getCustomerID(); 
                }

                commonProducts(c1.getCustomerID(), c2.getCustomerID());
            
	        	break;
	        	
	        case 7://exit
	        	break;
	        	
	        }
	        
			break;
			
		case 5:
			System.out.println("Exit with saving all data to original CSV files");

			customers.LoadToFile("customers.csv");
			System.out.println("Successfully saved into customers.csv");

			products.LoadToFile("products.csv");
			System.out.println("Successfully saved into products.csv");

			productData.getRemovedProducts().LoadToFile("Archivedproducts.csv");
			System.out.println("Successfully saved into Archivedproducts.csv");

			reviews.LoadToFile("reviews.csv");
			System.out.println("Successfully saved into reviews.csv");

			orders.LoadToFile("orders.csv");
			System.out.println("Successfully saved into orders.csv");
			break;
			
		case 6:
			
			break;
			
			
			
		
		}
	} while (managerChoice!=5 && managerChoice!=6);
	


}

public static void createReview() {

    System.out.println("Enter customer ID:");
    int customerID =input.nextInt();
    while (!customers.find(customerID)) {
        System.out.println("customer ID not available, please re-enter.");
        customerID =input.nextInt();
    }
    
    System.out.println("Enter product ID :");
    int productID =input.nextInt();
    while (!products.find(productID)) {
        System.out.println("product ID not available, Re-enter again");
        productID =input.nextInt();
    }
    
    Review review = reviewData.addReview(customerID, productID);
    System.out.println(review.toString());
	
}

public static void placeOrder() {
	 Order newOrder = new Order();
     double totalPrice = 0;
     
     System.out.println("Enter order ID:");
     int orderID = input.nextInt();
     while (orders.find(orderID)){
         System.out.println("Order ID already exists, please re-enter");
         orderID = input.nextInt();
     }
     newOrder.setOrderID(orderID);
     
     System.out.println("Enter customer ID:");
     int customerID = input.nextInt();
     while(! customers.find(customerID))     {
         System.out.println("Customer with the entered ID does not exist, please re-enter");
         customerID = input.nextInt();
     }
     newOrder.setCustomerReference(customerID);
     
     Customer customer = customers.retrieve();
     customer.addOrder(orderID);
     customers.update(customer);
     
     
     char answer = 'y';
     while (answer == 'y' || answer == 'Y') { 
         System.out.println("Enter product ID:");
         int productID = input.nextInt();
         
         if (products.find(productID))
         {
                 if (products.retrieve().getStock() == 0)
                     System.out.println("Product is out stock.");
                 else
                 {
                     Product pp = products.retrieve();
                     pp.setStock(pp.getStock()-1);
                     products.update(pp);
                     newOrder.addProduct(productID);
                 
                     System.out.println("Product successfully added your order!");
                     
                     totalPrice += pp.getPrice();
                 }
         }
         else
             System.out.println("Product ID doesn't exist.");
                 

             
         
         System.out.println("Do you want to continue adding a product?");
         answer = input.next().charAt(0);
     }
     
     newOrder.setTotalPrice(totalPrice);
     
     System.out.println("Enter the date:");
     DateTimeFormatter formatter = DateTimeFormatter.ofPattern("dd/MM/yyyy");
     LocalDate Ldate = LocalDate.parse(input.next(), formatter);
     newOrder.setDate(Ldate);

     System.out.println("Enter new status:");
     newOrder.setStatus(input.next());
     
     orders.insert(newOrder.getOrderID(), newOrder);
     
  
     
     System.out.println("Order added successfully");
     

}
	


public static double averageRating(int productID) {
	int counter =0;
    double rate = 0;
    
    reviews.findFirst();
    while (!reviews.last())
    {
        if (reviews.retrieve().getProduct() == productID)
        {
            counter ++;
            rate += reviews.retrieve().getRating();
        }
        reviews.findNext();
    }
    if (reviews.retrieve().getProduct() == productID)
    {
        counter ++;
        rate += reviews.retrieve().getRating();
    }
    
    if(counter==0)
    	return 0;
    return (rate/counter);
	
}

/*

 public static void top3Products(){

     LinkedPQ<Product> top3 = new LinkedPQ<Product> ();
     
     if (!products.empty())
     {
         products.findFirst();
         for (int i = 0 ; i < products.size() ; i++)
         {
             
             Product p = products.retrieve();
             double AVGrating = averageRating (p.productID);
            top3.enqueue(p, AVGrating);
             
             products.findNext();
         }
         
     }
     
     System.out.println("top 3 products by average rating from most to least.");
     for ( int j = 1 ; j <= 3 && top3.length() > 0 ; j++)
     {
         PQElement<Product> top = top3.serve();
         System.out.println("Product " + j + "  " + top.data.getProductID() 
                 + " " + top.data.getName() + " AVG rate (" + top.priority + ")" );
     }
	 
 }
 
 */


 
public static void commonProducts(int customerID1,int customerID2) {
    LinkedList<Integer> pcustomer1 = new LinkedList<Integer> ();
    LinkedList <Integer> pcustomer2 = new LinkedList <Integer> ();
    

    reviews = reviewData.getReviewDatabase();
    
    if (!reviews.empty())
    {
        reviews.findFirst();
        for (int i=1 ;i <= reviews.size() ; i++)
        {
            if (reviews.retrieve().getCustomer() == customerID1 )
            {
                pcustomer1.findFirst();
                boolean found1 = false;
                for (int x = 1; x <= pcustomer1.size() ; x++)
                {
                    if (pcustomer1.retrieve() == reviews.retrieve().getProduct())
                    {
                        found1 = true;
                        break;
                    }
                    pcustomer1.findNext();
                }
                pcustomer1.findLast();
                if (!found1 )
                    pcustomer1.insert(reviews.retrieve().getProduct());
            }
            
            if (reviews.retrieve().getCustomer() == customerID2 )
            {
                pcustomer2.findFirst();
                boolean found2 = false;
                for (int x = 1; x <= pcustomer2.size() ; x++)
                {
                    if (pcustomer2.retrieve() == reviews.retrieve().getProduct())
                    {
                        found2 = true;
                        break;
                    }
                    pcustomer2.findNext();
                }
                
                pcustomer2.findLast();
                if (!found2 )
                    pcustomer2.insert(reviews.retrieve().getProduct());
            }
            reviews.findNext();
        }
        System.out.println("Products with a rating above 4 for each customer are: ");
        System.out.println("Customer 1: ");
        pcustomer1.print();
        System.out.println("Customer 2: ");
        pcustomer2.print();
        
 
        LinkedPQ<Product> AVGrate4to5 = new LinkedPQ<Product> ();
        if (! pcustomer1.empty() && ! pcustomer2.empty())
        {
            pcustomer1.findFirst();
            for ( int m=1; m <= pcustomer1.size() ; m++)
            {
                int productID = pcustomer1.retrieve();
                pcustomer2.findFirst();
                for (int n = 1 ; n <= pcustomer2.size() ; n++)
                {
                    if (productID == pcustomer2.retrieve())
                    {
                        double AVGrating = averageRating (productID);
                        if (AVGrating >= 4)
                        {
                            Product p = productData.getProductData(productID);
                            AVGrate4to5.enqueue(p, AVGrating);
                        }
                    }
                    pcustomer2.findNext();
                }
                pcustomer1.findNext();
            }                
        
            
            while (AVGrate4to5.length() > 0)
            {
                PQElement<Product> product_rate = AVGrate4to5.serve();
                System.out.println("\nThere is a common product: " + product_rate.data.productID + " " + product_rate.data.getName() + " with a rating of " + product_rate.priority );
                System.out.println(product_rate.data);
                
            }
        }
        if(AVGrate4to5.length()==0)
            System.out.println("No common products between the customers.");
    }
    else
        System.out.println("Reviews not available for all products.");
}


 

 public static void customersBasedOnRating()
 {
     LinkedPQ<Customer> Rating = new LinkedPQ<Customer> ();
     products = productData.getproductsIDs();
     
     System.out.println("Enter product ID :");
     int pID =input.nextInt();
     while ( ! products.find(pID))
     {
         System.out.println("product ID not available, Re-enter again");
         pID =input.nextInt();
     }

     if ( reviews.empty())
     {
         System.out.println("No reviews are available");
         return;
     }
     
     reviews.findFirst();
     while ( ! reviews.last())
     {
         if (reviews.retrieve().getProduct() == pID )
             if (customers.find(reviews.retrieve().getCustomer()))
                 Rating.enqueue(customers.retrieve(), reviews.retrieve().getRating());
         reviews.findNext();
     }
     if (reviews.retrieve().getProduct() == pID )
         if (customers.find(reviews.retrieve().getCustomer()))
             Rating.enqueue(customers.retrieve(), reviews.retrieve().getRating());

     while ( Rating.length() > 0)
     {
         PQElement pq = Rating.serve();
         System.out.print(pq.data);
         System.out.println("");
         System.out.println("Customer has rated the product: " + pq.priority);
         System.out.println("");
     }
     
 }
 
 public static void customersBasedOnID()
 {
     AVLTree < Integer, Customer> CustomerIDs = new AVLTree< Integer, Customer> ();
     
     System.out.println("Enter product ID :");
     int productID =input.nextInt();
     while (!products.find(productID))
     {
         System.out.println("Product ID unavailable, please re-enter");
         productID =input.nextInt();
     }

     if (reviews.empty())
     {
         System.out.println("No available reviews.");
         return;
     }
     
     reviews.findFirst();
     while (!reviews.last())
     {
         if (reviews.retrieve().getProduct() == productID )
             if (customers.find(reviews.retrieve().getCustomer()))
            	 CustomerIDs.insert(customers.retrieve().getCustomerID(), customers.retrieve());
         reviews.findNext();
     }
     if (reviews.retrieve().getProduct() == productID )
         if (customers.find(reviews.retrieve().getCustomer()))
        	 CustomerIDs.insert(customers.retrieve().getCustomerID(), customers.retrieve());
     
     CustomerIDs.printKeys_Data();
}
 
 public static LinkedList <Review> reviewsForaCustomer()
 {
         System.out.println("Enter customer ID:");
         int customerID = input.nextInt();
         while(! customers.find(customerID))
         {
             System.out.println("Customer ID unavailable, please re-enter ");
             customerID = input.nextInt();
         }
     
         // collecting all reviews
         LinkedList <Review> selectedReviews = new LinkedList<Review> ();
         reviews.findFirst();
         while (! reviews.last())
         {
             if ( reviews.retrieve().getCustomer() == customerID)
                 selectedReviews.insert(reviews.retrieve());
             reviews.findNext();
         }
         if ( reviews.retrieve().getCustomer() == customerID)
             selectedReviews.insert(reviews.retrieve());

         // printing all reviews
         if (selectedReviews.empty())
             System.out.println("No reviews for customer with ID: " + customerID);
         else
         {
             selectedReviews.findFirst();
             while ( ! selectedReviews.last())
             {
                 System.out.println(selectedReviews.retrieve());
                 if (products.find(selectedReviews.retrieve().getProduct()))
                     System.out.println(products.retrieve());
                 else
                     System.out.println("No reviews for this product.\n");
              
                 
                 selectedReviews.findNext();
             }
             System.out.println(selectedReviews.retrieve());
             if (products.find(selectedReviews.retrieve().getProduct()))
                 System.out.println(products.retrieve());
             else
                 System.out.println("No reviews for this product.\n");

         }
         return selectedReviews;
 }
 
 public static void top3ProductsReviewd()
 {
     LinkedPQ<Product> top3Products = new LinkedPQ<Product> ();

     LinkedList<Product> allProducts = products.inOrdertraverseData();
     
     if (!allProducts.empty())
     {
         allProducts.findFirst();
         for (int i = 0 ; i < allProducts.size() ; i++)
         {
             Product p = allProducts.retrieve();
             
             int ReviewdCounter = 0;
             reviews.findFirst();
             while ( ! reviews.last())
             {
                 if ( reviews.retrieve().getProduct() == p.getProductID())
                     ReviewdCounter += 1;
                 reviews.findNext();
             }                
             if ( reviews.retrieve().getProduct() == p.getProductID())
                 ReviewdCounter += 1;

             top3Products.enqueue(p, ReviewdCounter);
             
             allProducts.findNext();
         }
     }
     
     System.out.println("Top 3 most reviewed products: ");
     for ( int j = 1 ; j <= 3 && top3Products.length() > 0 ; j++)
     {
         PQElement<Product> top = top3Products.serve();
         System.out.println("\n"+ j+ ") " +top.data.getProductID() 
                 + " , " + top.data.getName() + " has " + top.priority  + " reviews." );
     }
 }
 
 public static void top3ProductsRating()
 {
     LinkedPQ<Product> top3Products = new LinkedPQ<Product> ();

     LinkedList<Product> allProducts = products.inOrdertraverseData();
     
     if (!allProducts.empty())
     {
         allProducts.findFirst();
         for (int i = 0 ; i < allProducts.size() ; i++)
         {
             
             Product p = allProducts.retrieve();
             double AVGrating = averageRating(p.productID);
             top3Products.enqueue(p, AVGrating);
             
             allProducts.findNext();
         }
     }
     
     System.out.println("Top 3 most rated products: ");
     for ( int j = 1 ; j <= 3 && top3Products.length() > 0 ; j++)
     {
         PQElement<Product> top = top3Products.serve();
         System.out.println("\n"+ j+ ") " + top.data.getProductID() 
                 + " , " + top.data.getName() + " has " + top.priority + " average rating." );
     }
 }
 
	 
 }
